<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabular Transformer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#f6f9fc;--card:#fff;--accent:#2b8cc4;--ok:#4CAF50}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#222}
    .container{max-width:1100px;margin:32px auto;background:var(--card);padding:22px;border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,0.08)}
    h1{margin:0 0 12px;font-size:22px;color:#0f1724;text-align:center}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    label{font-weight:600;color:#0f1724}
    input[type="text"],input[type="number"],input[type="file"],select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
    button{background:var(--ok);color:white;padding:9px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    button[disabled]{background:#cfcfcf;cursor:not-allowed}
    .drop-zone{border:2px dashed #cbd5e1;border-radius:10px;padding:18px;text-align:center;background:#fbfdff;color:#334155}
    .drop-zone.dragover{background:#e6f2fb;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse;margin-top:10px;display:block;max-height:320px;overflow:auto}
    th,td{border:1px solid #e6e9ef;padding:8px;text-align:left;font-size:13px;white-space:nowrap}
    th{background:#f8fafc;position:sticky;top:0;z-index:2}
    .meta{margin-top:8px;font-weight:600;color:#0f1724}
    .controls {display:flex;gap:10px;flex-wrap:wrap}
    .small{width:110px}
    .wide{width:360px}
    .success{color:var(--ok);font-weight:700}
    .error{color:#dc2626;font-weight:700}
    @media (max-width:720px){.row{flex-direction:column;align-items:stretch}.small{width:100%}.wide{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Tabular Transformer</h1>

    <!-- Upload & Drag -->
    <div class="row">
      <div style="flex:1">
        <div id="dropZone" class="drop-zone">
          Drag & drop CSV / Excel here, or click to choose a file
          <div style="margin-top:8px;font-size:13px;color:#475569">(supports quoted CSV — commas inside quotes stay in the same cell)</div>
        </div>
        <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" style="margin-top:10px" />
      </div>
      <div style="min-width:220px">
        <div style="margin-bottom:8px"><label>Input summary</label></div>
        <div id="inputSummary" class="meta">No file loaded</div>
      </div>
    </div>

    <!-- Options -->
    <div class="row controls" style="margin-top:6px">
      <div>
        <label>Fixed columns (ranges)</label><br>
        <input id="fixedColumns" class="small" type="text" placeholder="e.g. 1:3,6,25:26" disabled />
      </div>

      <div>
        <label>Repeat group size</label><br>
        <input id="repeatSize" class="small" type="number" min="1" placeholder="e.g. 3" disabled />
      </div>

      <div>
        <label>Repeat range (start:end)</label><br>
        <input id="repeatRange" class="small" type="text" placeholder="e.g. 4:n" disabled />
      </div>

      <div style="flex:1">
        <label>Rename repeated columns (comma separated, optional)</label><br>
        <input id="repeatRename" class="wide" type="text" placeholder="e.g. Brand,Category,SKU" disabled />
      </div>

      <div style="min-width:220px">
        <label style="display:block">&nbsp;</label>
        <div>
          <input id="addCategory" type="checkbox" disabled />
          <label for="addCategory" style="font-weight:600">Add category column</label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="processBtn" disabled>Process</button>
      <button id="downloadX" disabled>Download Excel</button>
      <button id="downloadC" disabled>Download CSV</button>
      <div id="status" style="margin-left:8px"></div>
    </div>

    <!-- Previews -->
    <h3 style="margin-top:18px">Input preview (top 5 rows)</h3>
    <div id="inputPreview"></div>

    <h3 style="margin-top:18px">Output preview (top 5 rows)</h3>
    <div id="outputPreview"></div>
    <div id="outputSummary" class="meta" style="margin-top:6px"></div>
  </div>

  <script>
  let rawData = null;
  let processedData = null;

  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('dropZone');
  const fixedColumnsInput = document.getElementById('fixedColumns');
  const repeatSizeInput = document.getElementById('repeatSize');
  const repeatRangeInput = document.getElementById('repeatRange');
  const repeatRenameInput = document.getElementById('repeatRename');
  const addCategoryCheckbox = document.getElementById('addCategory');
  const processBtn = document.getElementById('processBtn');
  const downloadX = document.getElementById('downloadX');
  const downloadC = document.getElementById('downloadC');
  const inputPreview = document.getElementById('inputPreview');
  const outputPreview = document.getElementById('outputPreview');
  const inputSummary = document.getElementById('inputSummary');
  const statusEl = document.getElementById('status');
  const outputSummary = document.getElementById('outputSummary');

  // --- drag & drop
  ;['dragenter','dragover'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add('dragover');
    });
  });
  ;['dragleave','drop'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove('dragover');
    });
  });
  dropZone.addEventListener('drop', e => {
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) handleFile(f);
  });
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f);
  });

  // --- parse helpers
  function parseRanges(value) {
    if (!value) return null;
    return value.split(',').map(part => {
      part = part.trim();
      if (!part) return null;
      if (part.includes(':')) {
        let [s, e] = part.split(':');
        let start = parseInt(s, 10);
        let end = (e.toLowerCase() === 'n') ? rawData[0].length : parseInt(e, 10);
        if (isNaN(start) || isNaN(end)) return null;
        return { start: start - 1, end: end - 1 };
      } else {
        let idx = parseInt(part, 10);
        if (isNaN(idx)) return null;
        return { start: idx - 1, end: idx - 1 };
      }
    }).filter(r => r);
  }
  function parseRange(value) {
    if (!value) return null;
    if (value.includes(':')) {
      let [s, e] = value.split(':');
      let start = parseInt(s, 10);
      let end = (e.toLowerCase() === 'n') ? rawData[0].length : parseInt(e, 10);
      if (isNaN(start) || isNaN(end)) return null;
      return { start: start - 1, end: end - 1 };
    } else {
      let idx = parseInt(value, 10);
      if (isNaN(idx)) return null;
      return { start: idx - 1, end: idx - 1 };
    }
  }

  // --- category
  function categorizeItem(itemRaw) {
    const item = (itemRaw || '').toString().trim().toLowerCase();
    if (!item) return '';
    if (/(^|\s|\/)Atta($|\s|,|\.)|Maida|Semolina/.test(item)) return 'Flour';
    if (item.includes('Lentil')) return 'Lentil';
    if (item.includes('Mustard oil')) return 'Mustard Oil';
    if (item.includes('Puffed rice')) return 'Puffed Rice';
    if (/Rice chinigura|Rice others/.test(item)) return 'Rice';
    if (item.includes('Salt')) return 'Salt';
    return '';
  }

  // --- file parsing
  function handleFile(file){
    clearStatus();
    const ext = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();
    reader.onerror = () => showError('Unable to read file.');
    reader.onload = (ev) => {
      try {
        let wb;
        if (ext === 'csv' || ext === 'txt') {
          wb = XLSX.read(ev.target.result, { type: 'string' });
        } else {
          wb = XLSX.read(ev.target.result, { type: 'binary' });
        }
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
        const normalized = aoa.map(r => r.map(c => c ?? ''));
        rawData = normalized.filter(r => r.some(c => String(c).trim() !== ''));
        if (!rawData || rawData.length === 0) { showError('No data found.'); return; }

        fixedColumnsInput.disabled = false;
        repeatSizeInput.disabled = false;
        repeatRangeInput.disabled = false;
        repeatRenameInput.disabled = false;
        addCategoryCheckbox.disabled = false;
        processBtn.disabled = false;

        const cols = rawData[0].length;
        fixedColumnsInput.value = '1:3';
        repeatSizeInput.value = 3;
        repeatRangeInput.value = `${Math.min(4, cols)}:n`;

        renderInputPreview();
        inputSummary.textContent = `Input: ${rawData.length-1} rows × ${cols} columns (excluding header).`;
        status(`${file.name} loaded`,'success');
        outputPreview.innerHTML = ''; outputSummary.textContent = '';
        downloadX.disabled = true; downloadC.disabled = true;
      } catch(err){ console.error(err); showError('Failed to parse file.'); }
    };
    if (ext === 'csv' || ext === 'txt') reader.readAsText(file);
    else reader.readAsBinaryString(file);
  }

  // --- input preview
  function renderInputPreview(){
    inputPreview.innerHTML='';
    if (!rawData) return;
    const table=document.createElement('table');
    const numberRow=document.createElement('tr');
    rawData[0].forEach((_,i)=>{const th=document.createElement('th');th.textContent=i+1;numberRow.appendChild(th);});
    table.appendChild(numberRow);
    const headerRow=document.createElement('tr');
    rawData[0].forEach(h=>{const th=document.createElement('th');th.textContent=h;headerRow.appendChild(th);});
    table.appendChild(headerRow);
    rawData.slice(1,6).forEach(r=>{
      const tr=document.createElement('tr');
      r.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);});
      table.appendChild(tr);
    });
    inputPreview.appendChild(table);
  }

  // --- process
  function processData(){
    clearStatus();
    if (!rawData || rawData.length<2){showError('Load a file first.');return;}
    const fixedRanges=parseRanges(fixedColumnsInput.value);
    const repeatRange=parseRange(repeatRangeInput.value);
    const groupSize=parseInt(repeatSizeInput.value,10);
    if (!fixedRanges || !repeatRange || !groupSize){showError('Invalid ranges.');return;}

    const renameParts=(repeatRenameInput.value||'').split(',').map(s=>s.trim()).filter(s=>s);
    const addCategory=addCategoryCheckbox.checked;

    const headers=[];
    fixedRanges.forEach(r=>{for(let c=r.start;c<=r.end;c++){headers.push(rawData[0][c]||`Col${c+1}`);}});
    for (let i=0;i<groupSize;i++){headers.push(renameParts[i]||`Group${i+1}`);}
    if (addCategory) headers.push('Category');

    processedData=[headers];
    for (let r=1;r<rawData.length;r++){
      const row=rawData[r];
      const normalizedRow=Array.from({length:rawData[0].length},(_,i)=>row[i]??'');
      const fixedPart=[];
      fixedRanges.forEach(fr=>{for(let c=fr.start;c<=fr.end;c++){fixedPart.push(normalizedRow[c]);}});
      for (let c=repeatRange.start;c<=repeatRange.end;c+=groupSize){
        const group=normalizedRow.slice(c,c+groupSize);
        if (!group.some(v=>String(v).trim()!=='')) continue;
        const groupPadded=Array.from({length:groupSize},(_,i)=>group[i]??'');
        const outRow=[...fixedPart,...groupPadded];
        if (addCategory) outRow.push(categorizeItem(groupPadded[0]));
        processedData.push(outRow);
      }
    }
    renderOutputPreview();
    outputSummary.textContent=`Output: ${processedData.length-1} rows × ${processedData[0].length} columns (excluding header).`;
    downloadX.disabled=false; downloadC.disabled=false;
    status(`${processedData.length-1} rows produced`,'success');
  }

  function renderOutputPreview(){
    outputPreview.innerHTML='';
    if (!processedData) return;
    const table=document.createElement('table');
    const headerRow=document.createElement('tr');
    processedData[0].forEach(h=>{const th=document.createElement('th');th.textContent=h;headerRow.appendChild(th);});
    table.appendChild(headerRow);
    processedData.slice(1,6).forEach(r=>{
      const tr=document.createElement('tr');
      r.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);});
      table.appendChild(tr);
    });
    outputPreview.appendChild(table);
  }

  // --- downloads
  downloadX.addEventListener('click',()=>{
    const ws=XLSX.utils.aoa_to_sheet(processedData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Processed');
    XLSX.writeFile(wb,'processed_data.xlsx');
  });
  downloadC.addEventListener('click',()=>{
    const csv=processedData.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='processed_data.csv';link.click();
  });

  function showError(msg){statusEl.innerHTML=`<span class="error">${msg}</span>`;}
  function status(msg,type=''){statusEl.innerHTML=`<span class="${type==='success'?'success':''}">${msg}</span>`;}
  function clearStatus(){statusEl.innerHTML='';}

  processBtn.addEventListener('click',processData);
  </script>
</body>
</html>
